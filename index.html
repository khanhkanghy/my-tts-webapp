<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuyển Văn Bản Thành Giọng Nói</title>
    <!-- Tải Tailwind CSS từ CDN để dễ dàng tạo giao diện đẹp và responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Đảm bảo font Inter được sử dụng -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Màu nền nhẹ nhàng */
        }
        .container {
            max-width: 800px; /* Giới hạn chiều rộng của nội dung chính */
        }
        textarea {
            resize: vertical; /* Cho phép người dùng thay đổi kích thước chiều dọc của textarea */
        }
        /* Hiệu ứng loading */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Mặc định ẩn */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .table-container {
            max-height: 300px; /* Giới hạn chiều cao của bảng để có thể cuộn */
            overflow-y: auto; /* Cho phép cuộn dọc */
            border: 1px solid #e2e8f0; /* Border cho container */
            border-radius: 0.375rem; /* rounded-md */
        }
        table {
            width: 100%;
            border-collapse: collapse; /* Loại bỏ khoảng cách giữa các ô */
        }
        th, td {
            padding: 0.75rem; /* p-3 */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* border-b */
        }
        th {
            background-color: #f8fafc; /* bg-gray-50 */
            font-weight: 600; /* font-semibold */
            color: #4a5568; /* text-gray-700 */
            position: sticky; /* Giữ tiêu đề bảng khi cuộn */
            top: 0;
            z-index: 10;
        }
        tbody tr:last-child td {
            border-bottom: none; /* Loại bỏ border dưới cùng của hàng cuối */
        }
        tbody tr:hover {
            background-color: #f0f4f8; /* Hiệu ứng hover */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container bg-white p-8 rounded-lg shadow-xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Chuyển Văn Bản Thành Giọng Nói</h1>

        <!-- Phần tải lên tệp -->
        <div class="mb-6 border p-4 rounded-md bg-gray-50">
            <label for="fileInput" class="block text-gray-700 text-sm font-semibold mb-2">Tải lên tệp văn bản (.txt):</label>
            <input type="file" id="fileInput" accept=".txt" class="w-full text-gray-700">
            <button id="processFileButton"
                    class="mt-3 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-300 ease-in-out flex items-center justify-center">
                <span id="processFileButtonText">Xử lý tệp</span>
                <div id="fileLoader" class="loader ml-2"></div>
            </button>
        </div>

        <!-- Phần hiển thị danh sách đoạn văn bản -->
        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-semibold mb-2">Các đoạn văn bản đã xử lý:</label>
            <div id="textSegmentsContainer" class="table-container hidden">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr>
                            <th class="w-1/12">Chọn</th>
                            <th class="w-8/12">Nội dung</th>
                            <th class="w-2/12">Ký tự</th>
                            <th class="w-1/12">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="textSegmentsTableBody">
                        <!-- Các đoạn văn bản sẽ được thêm vào đây bằng JavaScript -->
                    </tbody>
                </table>
            </div>
            <p id="noSegmentsMessage" class="text-gray-500 text-center mt-4">Chưa có đoạn văn bản nào được tải lên hoặc xử lý.</p>
        </div>

        <div class="mb-6">
            <label for="textInput" class="block text-gray-700 text-sm font-semibold mb-2">Hoặc nhập văn bản trực tiếp:</label>
            <textarea id="textInput"
                      class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      rows="8"
                      placeholder="Nhập văn bản bạn muốn chuyển thành giọng nói tại đây..."></textarea>
        </div>

        <div class="mb-6">
            <label for="languageSelect" class="block text-gray-700 text-sm font-semibold mb-2">Chọn ngôn ngữ:</label>
            <select id="languageSelect"
                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="vi-vn">Tiếng Việt</option> 
                <option value="en-us">Tiếng Anh (Mỹ)</option>
                <option value="ja-jp">Tiếng Nhật</option>
                <option value="ko-kr">Tiếng Hàn</option>
                <option value="zh-cn">Tiếng Trung (Quan thoại)</option>
                <option value="fr-fr">Tiếng Pháp</option>
                <option value="de-de">Tiếng Đức</option>
                <!-- Thêm các ngôn ngữ khác mà VoiceRSS hỗ trợ. Đảm bảo dùng định dạng mã ngôn ngữ của VoiceRSS (ví dụ: en-us, vi-vn) -->
            </select>
        </div>

        <div class="mb-6">
            <label for="voiceSelect" class="block text-gray-700 text-sm font-semibold mb-2">Chọn giọng đọc:</label>
            <select id="voiceSelect"
                    class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <!-- Các tùy chọn giọng đọc sẽ được điền tự động bằng JavaScript dựa trên ngôn ngữ -->
                <option value="">Chọn một ngôn ngữ trước</option>
            </select>
        </div>

        <button id="convertButton"
                class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 ease-in-out flex items-center justify-center">
            <span id="buttonText">Chuyển đổi</span>
            <div id="loader" class="loader ml-2"></div>
        </button>

        <div id="messageBox" class="mt-4 p-3 bg-red-100 text-red-700 rounded-md hidden" role="alert">
            <!-- Hộp thông báo lỗi -->
        </div>

        <div class="mt-6">
            <label for="audioPlayer" class="block text-gray-700 text-sm font-semibold mb-2">Kết quả âm thanh:</label>
            <audio id="audioPlayer" controls class="w-full bg-gray-100 rounded-md p-2"></audio>
        </div>
    </div>

    <script>
        // Lấy các phần tử DOM cần thiết
        const textInput = document.getElementById('textInput');
        const languageSelect = document.getElementById('languageSelect');
        const voiceSelect = document.getElementById('voiceSelect'); 
        const convertButton = document.getElementById('convertButton');
        const audioPlayer = document.getElementById('audioPlayer');
        const messageBox = document.getElementById('messageBox');
        const loader = document.getElementById('loader');
        const buttonText = document.getElementById('buttonText');

        // Các phần tử mới cho chức năng tải tệp
        const fileInput = document.getElementById('fileInput');
        const processFileButton = document.getElementById('processFileButton');
        const processFileButtonText = document.getElementById('processFileButtonText');
        const fileLoader = document.getElementById('fileLoader');
        const textSegmentsContainer = document.getElementById('textSegmentsContainer');
        const textSegmentsTableBody = document.getElementById('textSegmentsTableBody');
        const noSegmentsMessage = document.getElementById('noSegmentsMessage');

        // URL của Serverless Function Vercel
        const API_FUNCTION_URL = '/api/synthesize'; 
        // URL cho Serverless Function xử lý tệp (sẽ tạo sau)
        const PROCESS_FILE_API_URL = '/api/process-file'; 

        // Danh sách các giọng đọc có sẵn cho từng ngôn ngữ (đơn giản hóa cho VoiceRSS)
        const voices = {
            'vi-vn': [ 
                { name: 'vi-vn', gender: 'Mặc định (Tiếng Việt)' }
            ],
            'en-us': [
                { name: 'en-us', gender: 'Mặc định (Tiếng Anh Mỹ)' }
            ],
            'ja-jp': [
                { name: 'ja-jp', gender: 'Mặc định (Tiếng Nhật)' }
            ],
            'ko-kr': [
                { name: 'ko-kr', gender: 'Mặc định (Tiếng Hàn)' }
            ],
            'zh-cn': [
                { name: 'zh-cn', gender: 'Mặc định (Tiếng Trung)' }
            ],
            'fr-fr': [
                { name: 'fr-fr', gender: 'Mặc định (Tiếng Pháp)' }
            ],
            'de-de': [
                { name: 'de-de', gender: 'Mặc định (Tiếng Đức)' }
            ]
        };

        // Hàm hiển thị thông báo lỗi
        function showMessage(message, isError = true) {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.classList.remove('bg-green-100', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.remove('bg-red-100', 'text-red-700');
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }
        }

        // Hàm ẩn thông báo
        function hideMessage() {
            messageBox.classList.add('hidden');
        }

        // Hàm cập nhật danh sách giọng đọc khi ngôn ngữ thay đổi
        function updateVoiceOptions() {
            const selectedLanguage = languageSelect.value;
            const availableVoices = voices[selectedLanguage] || [];
            voiceSelect.innerHTML = ''; 

            if (availableVoices.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Không có giọng đọc cho ngôn ngữ này';
                voiceSelect.appendChild(option);
                voiceSelect.disabled = true;
            } else {
                voiceSelect.disabled = false;
                availableVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.gender}`; 
                    voiceSelect.appendChild(option);
                });
            }
        }

        // Hàm hiển thị các đoạn văn bản trong bảng
        function displayTextSegments(segments) {
            textSegmentsTableBody.innerHTML = ''; // Xóa nội dung cũ
            if (segments && segments.length > 0) {
                textSegmentsContainer.classList.remove('hidden');
                noSegmentsMessage.classList.add('hidden');
                segments.forEach((segment, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 rounded" checked data-segment-id="${index}"></td>
                        <td class="text-sm text-gray-800">${segment.text.substring(0, 100)}...</td>
                        <td class="text-sm text-gray-600">${segment.text.length}</td>
                        <td>
                            <button class="bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded-md play-segment-btn" data-segment-id="${index}">Nghe</button>
                        </td>
                    `;
                    textSegmentsTableBody.appendChild(row);
                });
            } else {
                textSegmentsContainer.classList.add('hidden');
                noSegmentsMessage.classList.remove('hidden');
            }
        }

        // Lưu trữ các đoạn văn bản đã xử lý (tạm thời trong bộ nhớ)
        let processedSegments = [];

        // Xử lý sự kiện khi nút "Xử lý tệp" được nhấp
        processFileButton.addEventListener('click', async () => {
            const file = fileInput.files[0];
            hideMessage();

            if (!file) {
                showMessage('Vui lòng chọn một tệp văn bản để xử lý.');
                return;
            }

            processFileButton.disabled = true;
            fileLoader.style.display = 'block';
            processFileButtonText.textContent = 'Đang xử lý...';
            processedSegments = []; // Xóa các đoạn cũ

            try {
                // Đọc nội dung tệp
                const fileContent = await file.text();
                
                // Tạm thời, chúng ta sẽ chia văn bản thành các dòng.
                // Trong phiên bản "chỉn chu", bạn sẽ gửi nội dung này đến Serverless Function
                // để phân tích và lưu vào cơ sở dữ liệu.
                const lines = fileContent.split('\n').filter(line => line.trim() !== '');
                
                // Giới hạn số lượng ký tự mỗi đoạn để tránh lỗi API TTS
                const MAX_SEGMENT_LENGTH = 4000; // VoiceRSS có thể có giới hạn riêng
                let currentSegment = '';
                let segmentIndex = 0;

                for (const line of lines) {
                    if ((currentSegment + ' ' + line).length <= MAX_SEGMENT_LENGTH) {
                        currentSegment += (currentSegment ? ' ' : '') + line;
                    } else {
                        if (currentSegment) {
                            processedSegments.push({ id: segmentIndex++, text: currentSegment });
                        }
                        currentSegment = line;
                    }
                }
                if (currentSegment) {
                    processedSegments.push({ id: segmentIndex++, text: currentSegment });
                }

                // Hiển thị các đoạn văn bản đã xử lý
                displayTextSegments(processedSegments);
                showMessage(`Đã xử lý tệp "${file.name}" thành ${processedSegments.length} đoạn.`, false);

                // Tạm thời, chúng ta không gửi đến backend ngay.
                // Trong phiên bản chỉn chu, bạn sẽ gửi fileContent đến PROCESS_FILE_API_URL
                // const response = await fetch(PROCESS_FILE_API_URL, {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ fileName: file.name, content: fileContent })
                // });
                // const data = await response.json();
                // processedSegments = data.segments; // Giả định backend trả về các segments
                // displayTextSegments(processedSegments);
                // showMessage(`Đã xử lý tệp "${file.name}" thành ${processedSegments.length} đoạn.`, false);

            } catch (error) {
                console.error('Lỗi khi xử lý tệp:', error);
                showMessage(`Lỗi khi xử lý tệp: ${error.message}`);
            } finally {
                processFileButton.disabled = false;
                fileLoader.style.display = 'none';
                processFileButtonText.textContent = 'Xử lý tệp';
            }
        });

        // Xử lý sự kiện khi nút "Chuyển đổi" được nhấp (đã có từ trước)
        convertButton.addEventListener('click', async () => {
            let textToConvert = textInput.value.trim();
            
            // Nếu có các đoạn văn bản đã xử lý và được chọn, ưu tiên chúng
            const selectedSegments = Array.from(document.querySelectorAll('#textSegmentsTableBody input[type="checkbox"]:checked'))
                                          .map(checkbox => parseInt(checkbox.dataset.segmentId))
                                          .map(id => processedSegments.find(s => s.id === id));

            if (selectedSegments.length > 0) {
                // Nối các đoạn văn bản đã chọn lại với nhau (có thể cần logic phức tạp hơn cho batch processing)
                textToConvert = selectedSegments.map(s => s.text).join(' ');
                // Trong một ứng dụng chỉn chu, bạn sẽ gửi từng đoạn riêng lẻ đến backend
                // và backend sẽ xử lý từng đoạn, lưu trữ âm thanh riêng biệt.
            } else if (!textToConvert) {
                showMessage('Vui lòng nhập văn bản hoặc chọn các đoạn văn bản đã xử lý để chuyển đổi.');
                return;
            }

            const languageCode = languageSelect.value;
            const voiceName = voiceSelect.value; 

            hideMessage(); 

            if (!languageCode) { 
                showMessage('Vui lòng chọn một ngôn ngữ.');
                return;
            }

            // Hiển thị loading và vô hiệu hóa nút
            convertButton.disabled = true;
            loader.style.display = 'block';
            buttonText.textContent = 'Đang chuyển đổi...';
            audioPlayer.src = ''; 

            try {
                // Gửi yêu cầu đến Vercel Serverless Function
                const response = await fetch(API_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: textToConvert, languageCode, voiceName }) 
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Đã xảy ra lỗi khi chuyển đổi văn bản.');
                }

                const data = await response.json();
                if (data.audioContent) {
                    // Tạo URL từ dữ liệu base64 và gán vào thẻ audio
                    audioPlayer.src = `data:audio/mpeg;base64,${data.audioContent}`;
                    audioPlayer.play(); 
                    showMessage('Chuyển đổi thành công!', false);
                } else {
                    showMessage('Không nhận được nội dung âm thanh từ máy chủ.');
                }
            } catch (error) {
                console.error('Lỗi:', error);
                showMessage(`Lỗi: ${error.message}`);
            } finally {
                // Ẩn loading và kích hoạt lại nút
                convertButton.disabled = false;
                loader.style.display = 'none';
                buttonText.textContent = 'Chuyển đổi';
            }
        });

        // Xử lý sự kiện click nút "Nghe" trên từng đoạn
        textSegmentsTableBody.addEventListener('click', async (event) => {
            if (event.target.classList.contains('play-segment-btn')) {
                const segmentId = parseInt(event.target.dataset.segmentId);
                const segment = processedSegments.find(s => s.id === segmentId);

                if (segment) {
                    hideMessage();
                    const languageCode = languageSelect.value;
                    const voiceName = voiceSelect.value; 

                    if (!languageCode) { 
                        showMessage('Vui lòng chọn một ngôn ngữ trước khi nghe đoạn này.');
                        return;
                    }

                    // Tạm thời vô hiệu hóa nút chính và hiển thị loading cho nút nghe
                    event.target.disabled = true;
                    event.target.textContent = 'Đang tải...';

                    try {
                        const response = await fetch(API_FUNCTION_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: segment.text, languageCode, voiceName })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Lỗi khi tạo âm thanh đoạn văn bản.');
                        }

                        const data = await response.json();
                        if (data.audioContent) {
                            audioPlayer.src = `data:audio/mpeg;base64,${data.audioContent}`;
                            audioPlayer.play();
                        } else {
                            showMessage('Không nhận được nội dung âm thanh cho đoạn này.');
                        }
                    } catch (error) {
                        console.error('Lỗi khi nghe đoạn:', error);
                        showMessage(`Lỗi khi nghe đoạn: ${error.message}`);
                    } finally {
                        event.target.disabled = false;
                        event.target.textContent = 'Nghe';
                    }
                }
            }
        });


        // Gọi hàm cập nhật giọng đọc khi trang tải và khi ngôn ngữ thay đổi
        document.addEventListener('DOMContentLoaded', updateVoiceOptions);
        languageSelect.addEventListener('change', updateVoiceOptions);
    </script>
</body>
</html>
